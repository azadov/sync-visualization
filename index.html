<!DOCTYPE html>
<meta charset="utf-8">
<style>

    body {
        font: 10px sans-serif;
    }

    .rectangle {
        /* fill: steelblue */
        fill: red;
    }
    #plotContainer {
        float:right;

    }


</style>
<body>

<input type="button" name="Text 2" value="Stop"
       onclick="stop()">     <!-- d3.select('svg').remove() -->
<p id="scoreID"></p>
<div id="plotContainer"> </div>
<div id="PeachnoteViewerContainerId"> </div>
<br>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="jquery-1.10.2.min.js"></script>
<script>

(function () {
    var pnsv = document.createElement('script');
    pnsv.type = 'text/javascript';
    pnsv.async = true;
    pnsv.src = 'http://pchnote.appspot.com/scoreviewer/scoreviewer.nocache.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(pnsv);
})();

var _pnq = _pnq || [];
_pnq.push(['rootElement', 'PeachnoteViewerContainerId']);
_pnq.push(['widgetHeight', 330]);
_pnq.push(['addMeasureClickHandler', function (scoreId, page, measureNumber, totalMeasures) {
    console.log("clicked on page " + page + ", measure " + measureNumber + " of total " + totalMeasures + " measures");
    //var videoTime = getVideoTimeForPagePosition(page, (measureNumber - 1) / totalMeasures);
    var state = videoState;
    _pnq.push(["clearMeasureHighlightings"]);
    _pnq.push(["highlightMeasure", measureNumber, page]);
//        ytplayer.seekTo(Math.max(0, videoTime));
//        if (state != 1) {
//            ytplayer.pauseVideo();
//        }
}]);

var rectHeight = 0.05;
var distanceBetweenRects = 0.5;
var numOfLevels = 1;

var scoreToVids = {};
var filenames = [];
var sIDs = [];
var pageTimes = [];

$.getJSON('test/alignmentQuality.json', function (json) {
    for (var i = 0; i < json.length; i++) {
        var sid = json[i].id0;
        var id1 = json[i].id1;
        var fname = "test/" + sid + '_' + id1 + '.json';

        //console.log(sid + "      " + fname);
        if ( scoreToVids[sid] ) {scoreToVids[sid].push(fname); }
        else {scoreToVids[sid] = [fname]; sIDs.push(sid); }
    }

    iterateFiles();
});

var files = [];
var sIDNumber = 0;
var activeInterval;
function iterateFiles() {
// 00155_6D5im3E8E7E.json  3
// 00155_KDOtrTCUHBY.json  1
// 00155_qEzZw8QIZ90.json  6
// 00155_SxMFjM42CY8.json  1
    //var files = ['00155/00155_6D5im3E8E7E.json', '00155/00155_KDOtrTCUHBY.json', '00155/00155_qEzZw8QIZ90.json', '00155/00155_SxMFjM42CY8.json']

//    var scoreToVids2 = {};
//    scoreToVids2["00001"] = scoreToVids["00001"];
//    scoreToVids2["01986"] = scoreToVids["01986"];
//    scoreToVids =  scoreToVids2;
//    sIDs=[];
//    sIDs.push("00001"); sIDs.push("01986");

    activeInterval = setInterval("drawPlot()", 2000);
    //drawPlot();
//    for (var key in scoreToVids) {
//        if (scoreToVids.hasOwnProperty(key)) {
//            files = scoreToVids[key];
//            console.log(key);
//            //drawPlot();
//            setTimeout("drawPlot()", 4000);
//        }
//    }
}

function drawPlot() {
    d3.select('svg').remove();
    //d3.select('rect').remove();
    //d3.select('path').remove();

    numOfLevels = 1;

    var svg = createAndGetSVGObject();

    var doneCount = 0;
    var data = [];

    files = scoreToVids[sIDs[sIDNumber]];
    document.getElementById("scoreID").innerHTML = "ScoreID: " + sIDs[sIDNumber];
    //console.log(files);

    _pnq.push(['loadScore', "IMSLP" + sIDs[sIDNumber]]);

    $.each(files, function (i, file) {
        $.getJSON(file, function (json) {
            doneCount++;
            //result += json.field1;
            data.push(json);
            if (doneCount == files.length) {
                visualizeData(data, svg);

                sIDNumber++;
                if ( sIDNumber >= sIDs.length )   clearInterval(activeInterval);
            }
        })
    });
}

function stop(){
    clearInterval(activeInterval);
}

var maxX = 0;
var maxY = 0;
function visualizeData(_data, _svg){
//$.getJSON('00155_qEzZw8QIZ90.json', function(data) {
    var basis;
    var notbasis;
    //var maxX = 0;
    var all_rects = [];
    var rects_basis = [];
    var curves = [];


    _data.forEach(function(data) {
        rects_basis = [];
        //curves = [];
        data.localTimeMaps.forEach(function(d) {
            basis = d[0];
            notbasis = d[1];

            if ( maxX < basis[basis.length - 1] ) {
                maxX = basis[basis.length - 1];
            }

            rectangle_basis = {};
            rectangle_basis.x1 = basis[0];
            rectangle_basis.x2 = basis[basis.length - 1];
            //rectangle_basis.y = rects_basis.length*rectHeight + rectHeight;
            rectangle_basis.width = basis[basis.length - 1] - basis[0];
            rectangle_basis.x1_notbasis = notbasis[0];

            //console.log(notbasis[0] + "       " + notbasis[notbasis.length - 1]);

            rects_basis.push(rectangle_basis);

        });

        rects_basis = sortRects(rects_basis);
        assignY(rects_basis);

        for (var i = 0; i < rects_basis.length - 1; i++) {
            var firstPoint = {x: rects_basis[i].x2, y: rects_basis[i].y - rectHeight/2};

            var secondPoint = {x: rects_basis[i].x2 + 10, y: rects_basis[i].y - rectHeight/2};

            //var thirdPoint ={x: modulus(rects_basis[i].x2+rects_basis[i+1].x1)/2, y: rects_basis[i].y + modulus(rects_basis[i].y-rects_basis[i+1].y)/2};
            var thirdPoint ={x: rects_basis[i].x2 + 10, y: rects_basis[i].y + modulus(rects_basis[i].y-rects_basis[i+1].y)/2 - rectHeight/2};

            var fourthPoint = {x: rects_basis[i+1].x1 - 10, y: rects_basis[i].y + modulus(rects_basis[i].y-rects_basis[i+1].y)/2 - rectHeight/2};

            var fifthPoint = {x: rects_basis[i+1].x1 - 10, y: rects_basis[i+1].y - rectHeight/2};

            var sixthPoint = {x: rects_basis[i+1].x1, y: rects_basis[i+1].y - rectHeight/2};
            //console.log(rects_basis[i].x_notbasis);

            var curve = [];
            curve.push(firstPoint);
            curve.push(secondPoint);
            curve.push(thirdPoint);
            curve.push(fourthPoint);
            curve.push(fifthPoint);
            curve.push(sixthPoint);

            curves.push(curve);
        }
        joinArrays(all_rects, rects_basis);
    });

    //console.log("extremes: " + maxX_basis + "     " + numOfLevels * (rectHeight+distanceBetweenRects));
    x_scale.domain([0, maxX]);
    maxY = numOfLevels * (rectHeight+distanceBetweenRects);
    y_scale.domain([0, maxY]);
    pageTimes = _data[0].streamTimes0;
    var pageTimesArray = [];
    for (var key in pageTimes) {
        if (pageTimes.hasOwnProperty(key)) {
            pageTimesArray.push(pageTimes[key]);
        }
    }
    xAxis.tickValues(pageTimesArray);


    _svg.selectAll(".bar")
            .data(all_rects)
            .enter().append("rect")
            .attr("class", "rectangle")
            .attr("x", function(d) { return x_scale(d.x1); })
            .attr("width", function(d) { return x_scale(d.width); })
            .attr("y", function(d) { return y_scale(d.y); })
            .attr("height", plot_height - y_scale(rectHeight));



    // http://www.dashingd3js.com/svg-paths-and-d3js
    //var lineData = [ { "x": 61,  "y": 0.75}, { "x": 80,  "y": 0.75},
    //                 { "x": 55,  "y": 2.75}, { "x": 61,  "y": 2.75}];
    var lineFunction = d3.svg.line()
            .x(function(d) { return x_scale(d.x); })
            .y(function(d) { return y_scale(d.y); })
            .interpolate("basis");
    _svg.selectAll(".curve")
            .data(curves)
            .enter().append("path")
            .attr("d", function(d){return lineFunction(d);})
            .attr("stroke", "blue")
            .attr("stroke-width", 2)
        //.attr("stroke-dasharray", "2,2")
            .attr("fill", "none");
}

/**
 * sorts rectangles according the x coordinate of not basis file
 * @param _arrayOfRects
 * @returns {*}
 */
function sortRects(_arrayOfRects) {
    sortedArrayOfRects = [];

    var minElem = 1000000;
    var indexOfMinElem = 0;
    while ( _arrayOfRects.length > 0 ) {
        //console.log("bla" + _arrayOfRects);
        minElem = 1000000;
        indexOfMinElem = 0;
        for (var i = 0; i < _arrayOfRects.length; i++) {
            if ( minElem > _arrayOfRects[i].x1_notbasis ) {
                minElem = _arrayOfRects[i].x1_notbasis;
                indexOfMinElem = i;
            }
        }
        //console.log(_arrayOfRects[indexOfMinElem].x_notbasis + "      " + minElem);

        sortedArrayOfRects.push(_arrayOfRects[indexOfMinElem]);

        _arrayOfRects.splice(indexOfMinElem, 1);
    }
    //alert(_arrayOfRects.length);

    return sortedArrayOfRects;
}

function assignY(_arrayOfSortedRects) {
    numOfLevels++;
    _arrayOfSortedRects[0].y = numOfLevels*(rectHeight + distanceBetweenRects);
    //var numOfLevels = 1;
    for (var i = 1; i < _arrayOfSortedRects.length; i++) {
        if ( _arrayOfSortedRects[i-1].x2 < _arrayOfSortedRects[i].x1 ) {
            _arrayOfSortedRects[i].y = _arrayOfSortedRects[i-1].y;
        } else {
            numOfLevels++;
            _arrayOfSortedRects[i].y = numOfLevels*(rectHeight + distanceBetweenRects);
        }
    }
}

var plot_margin = {top: 20, right: 20, bottom: 30, left: 40},
        plot_width = 700 - plot_margin.left - plot_margin.right,
        plot_height = 350 - plot_margin.top - plot_margin.bottom;

var x_scale = d3.scale.linear()
        .range([0,plot_width]);

var y_scale = d3.scale.linear()
        .range([plot_height, 0]);

var xAxis = d3.svg.axis()
        .scale(x_scale)
        .orient("bottom");
        //.tickValues([50, 100, 150, 200, 250, 300])
        //.ticks(["a","b","c","d","e","f"]);

function createAndGetSVGObject(){

//plot_height = 500 - plot_margin.top - plot_margin.bottom;

//    x_scale = d3.scale.linear()
//            .range([0,plot_width]);
//
//    y_scale = d3.scale.linear()
//            .range([plot_height, 0]);
    //console.log("width: " + plot_width + "     height: " + plot_height);
//    var xAxis = d3.svg.axis()
//            .scale(x_scale)
//            .orient("bottom")
//            .tickValues([50, 100, 150, 200, 250, 300])
//            .ticks(["a","b","c","d","e","f"]);

    var yAxis = d3.svg.axis()
            .scale(y_scale)
            .orient("left");
    ///d3.select("body").append("svg")
    var svg_basis = d3.select("#plotContainer").append("svg")
            .attr("width", plot_width + plot_margin.left + plot_margin.right)
            .attr("height", plot_height + plot_margin.top + plot_margin.bottom)
            .append("g")
            .attr("transform", "translate(" + plot_margin.left + "," + plot_margin.top + ")")
            .on("click", mouseClickXAxis);

    svg_basis.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + plot_height + ")")
            .call(xAxis)

    svg_basis.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Frequency");

    return svg_basis;
}

function mouseClickXAxis(d) {
    //console.log("x: " + d3.mouse(this)[0] + "     y: " + d3.mouse(this)[1]);
    //console.log("x sc: " + x_scale(d3.mouse(this)[0]) + "     y sc: " + y_scale(d3.mouse(this)[1]));
    //console.log("x inv: " + x_scale.invert(d3.mouse(this)[0]) + "     y inv: " + y_scale.invert(d3.mouse(this)[1]));
    //console.log("x inv: " + invertCoordinates(d3.mouse(this))[0] + "    y inv: " + invertCoordinates(d3.mouse(this))[1]);
    //console.log("maxX: " + maxX + "    width: " + plot_width + "    quot: " + maxX/plot_width);
    //console.log(d3.select(this));
    //console.log(d);
    var pageAndTime = getPageAndTime(x_scale.invert(d3.mouse(this)[0]));
    var page = pageAndTime.page;
    var pageTime = pageAndTime.pageTime;

    _pnq.push(['loadPage', page]);
}

function invertCoordinates(d){
    //d[0];
    //return [maxX/plot_width * d[0], maxY/plot_height * d[1]];
    return [maxX/plot_width * d[0], maxY/plot_height * d[1]];
}

function getPageAndTime(_scoreTime){
    var page = 0;
    var pageTime = 0;
    console.log("score time: " + _scoreTime);
    for (var i in pageTimes) {
        page = i;
        pageTime = pageTimes[i];
        if (pageTime >= _scoreTime) {
            console.log("page: " + page - 1);
            return {"page": (page - 1), "pageTime": _scoreTime};
        }
    }
    console.log("page: " + page);
    return {"page": page, "pageTime": _scoreTime};
}

function joinArrays(_array1, _array2) {
    for (var i = 0; i < _array2.length; i++) {
        _array1.push(_array2[i]);
    }
}

function modulus(_value) {
    if ( _value >= 0 ) {
        return _value;
    } else {
        return 0 - _value;
    }
}

</script>

